<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAHAIÂ·æ™ºèƒ½å½±é™¢ | å…¨ç½‘èµ„æºä¸€é”®æ’­æ”¾</title>
    <style>
        /* ä¿ç•™åŸæœ‰æ‰€æœ‰æ ·å¼ï¼Œåªæ·»åŠ æ–°æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d4ff;
            --secondary: #9d4edd;
            --accent: #ff6b6b;
            --dark: #0a0a0f;
            --darker: #050508;
            --light: #e0e0e0;
            --glass: rgba(255, 255, 255, 0.05);
            --glow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, #0f172a 100%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* æ–°å¢ï¼šæœç´¢ç»“æœæ ·å¼ */
        .search-results {
            display: none;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .result-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--glow);
        }

        .result-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .result-info {
            padding: 1rem;
        }

        .result-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .result-year {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        /* æ–°å¢ï¼šæ’­æ”¾æºé€‰æ‹© */
        .source-selector {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .source-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--light);
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .source-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .source-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        /* æ–°å¢ï¼šåŠ è½½åŠ¨ç”» */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            color: var(--primary);
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        /* ä¿ç•™åŸæœ‰æ‰€æœ‰å…¶ä»–æ ·å¼... */
        /* ç”±äºæ ·å¼ä»£ç å¾ˆé•¿ï¼Œè¿™é‡Œåªæ˜¾ç¤ºæ–°å¢éƒ¨åˆ†ï¼ŒåŸæ ·å¼ä¿æŒä¸å˜ */
        /* ... åŸæœ‰çš„å¯¼èˆªæ ã€å¡ç‰‡ã€æ¨¡æ€æ¡†ç­‰æ‰€æœ‰æ ·å¼ ... */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- èƒŒæ™¯ç²’å­ -->
    <div id="particles-js"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">DAHAI CINEMA</div>
        <div class="nav-center">
            <a href="#" class="nav-item" id="homeBtn"><i class="fas fa-home"></i> é¦–é¡µ</a>
            <a href="#" class="nav-item" id="moviesBtn"><i class="fas fa-film"></i> ç”µå½±</a>
            <a href="#" class="nav-item" id="tvBtn"><i class="fas fa-tv"></i> å‰§é›†</a>
            <a href="#" class="nav-item" id="animeBtn"><i class="fas fa-gamepad"></i> åŠ¨æ¼«</a>
        </div>
        <div class="user-menu">
            <button class="nav-item" id="userBtn"><i class="fas fa-user"></i> å¤§æµ·</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main>
        <!-- è‹±é›„åŒºåŸŸ -->
        <section class="hero">
            <h1 class="hero-title floating">æ™ºèƒ½å½±è§†æœç´¢å¼•æ“</h1>
            <p class="hero-subtitle">
                è¾“å…¥ç”µå½±/å‰§é›†åç§°ï¼Œè‡ªåŠ¨åŒ¹é…å°é¢ï¼Œå¤šæºæ’­æ”¾ï¼Œä¸€ç«™å¼è§‚å½±ä½“éªŒ
            </p>
            
            <!-- æ™ºèƒ½æœç´¢æ¡† -->
            <div class="search-container">
                <input type="text" 
                       class="search-box" 
                       placeholder="è¾“å…¥ç”µå½±ã€ç”µè§†å‰§ã€åŠ¨æ¼«åç§°ï¼Œå¦‚ï¼šæµæµªåœ°çƒã€æƒåŠ›çš„æ¸¸æˆ..." 
                       id="searchInput"
                       autocomplete="off">
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i> æ™ºèƒ½æœç´¢
                </button>
            </div>
            
            <!-- çƒ­é—¨æœç´¢æç¤º -->
            <div class="quick-links">
                <a href="#" class="quick-link" data-search="æµæµªåœ°çƒ2">
                    <i class="fas fa-rocket"></i> æµæµªåœ°çƒ2
                </a>
                <a href="#" class="quick-link" data-search="æ»¡æ±Ÿçº¢">
                    <i class="fas fa-dragon"></i> æ»¡æ±Ÿçº¢
                </a>
                <a href="#" class="quick-link" data-search="ç‹‚é£™">
                    <i class="fas fa-bolt"></i> ç‹‚é£™
                </a>
                <a href="#" class="quick-link" data-search="ä¸‰ä½“">
                    <i class="fas fa-globe"></i> ä¸‰ä½“
                </a>
                <a href="#" class="quick-link" data-search="é¬¼ç­ä¹‹åˆƒ">
                    <i class="fas fa-fire"></i> é¬¼ç­ä¹‹åˆƒ
                </a>
            </div>
        </section>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <div class="search-results" id="searchResults">
            <h2 class="section-title">
                <i class="fas fa-search"></i> æœç´¢ç»“æœ
                <span id="resultCount" style="font-size: 1rem; color: var(--primary); margin-left: 1rem;"></span>
            </h2>
            
            <!-- æ’­æ”¾æºé€‰æ‹© -->
            <div class="source-selector" id="sourceSelector">
                <button class="source-btn active" data-source="all">å…¨éƒ¨æ¥æº</button>
                <button class="source-btn" data-source="bilibili">Bç«™èµ„æº</button>
                <button class="source-btn" data-source="iqiyi">çˆ±å¥‡è‰º</button>
                <button class="source-btn" data-source="tencent">è…¾è®¯è§†é¢‘</button>
                <button class="source-btn" data-source="youku">ä¼˜é…·</button>
            </div>
            
            <div class="results-grid" id="resultsGrid">
                <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p class="loading-text">æ­£åœ¨æœç´¢å…¨ç½‘èµ„æº...</p>
            </div>
        </div>

        <!-- æ¨èåŒºåŸŸï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div class="recommendations" id="recommendations">
            <!-- çƒ­é—¨æ¨è -->
            <h2 class="section-title">
                <i class="fas fa-fire"></i> çƒ­é—¨æ¨è
            </h2>
            <div class="movies-grid" id="hotMovies">
                <!-- åŠ¨æ€ç”Ÿæˆçƒ­é—¨æ¨è -->
            </div>

            <!-- æœ€æ–°ä¸Šæ˜  -->
            <h2 class="section-title">
                <i class="fas fa-bolt"></i> æœ€æ–°ä¸Šçº¿
            </h2>
            <div class="movies-grid" id="newMovies">
                <!-- åŠ¨æ€ç”Ÿæˆæœ€æ–°ä¸Šçº¿ -->
            </div>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loader" id="loader"></div>
    </main>

    <!-- æ™ºèƒ½æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ™ºèƒ½æ’­æ”¾å™¨</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="source-btn active" data-player="bilibili">Bç«™æ’­æ”¾</button>
                    <button class="source-btn" data-player="iframe">ç½‘é¡µåµŒå…¥</button>
                    <button class="source-btn" data-player="direct">ç›´æ¥æ’­æ”¾</button>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
            </div>
            <div class="video-container" id="videoContainer">
                <div style="text-align: center; padding: 3rem;">
                    <div class="spinner"></div>
                    <p style="color: var(--primary); margin-top: 1rem;">æ­£åœ¨è§£ææœ€ä½³æ’­æ”¾æº...</p>
                </div>
            </div>
            <div style="padding: 1rem 2rem; background: rgba(0,0,0,0.3);">
                <h4 style="margin-bottom: 0.5rem; color: var(--primary);">
                    <i class="fas fa-info-circle"></i> æ’­æ”¾æç¤º
                </h4>
                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                    1. å¦‚é‡æ— æ³•æ’­æ”¾ï¼Œè¯·å°è¯•åˆ‡æ¢æ’­æ”¾æº<br>
                    2. Bç«™èµ„æºå¯èƒ½å—åœ°åŸŸé™åˆ¶<br>
                    3. éƒ¨åˆ†èµ„æºéœ€è¦VIPæƒé™<br>
                    4. æ¨èä½¿ç”¨Chromeæµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒ
                </p>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>æ™ºèƒ½å½±è§†å¼•æ“</h3>
                <p>è‡ªåŠ¨åŒ¹é…å°é¢ + å¤šæºæ’­æ”¾ + æ™ºèƒ½æœç´¢</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-github"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-weibo"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h3>æ•°æ®æ¥æº</h3>
                <ul class="footer-links">
                    <li><a href="https://www.bilibili.com" target="_blank"><i class="fas fa-external-link-alt"></i> å“”å“©å“”å“©</a></li>
                    <li><a href="https://www.iqiyi.com" target="_blank"><i class="fas fa-external-link-alt"></i> çˆ±å¥‡è‰º</a></li>
                    <li><a href="https://v.qq.com" target="_blank"><i class="fas fa-external-link-alt"></i> è…¾è®¯è§†é¢‘</a></li>
                    <li><a href="https://www.youku.com" target="_blank"><i class="fas fa-external-link-alt"></i> ä¼˜é…·è§†é¢‘</a></li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            æœ¬ç½‘ç«™ä»…ä¸ºæŠ€æœ¯æ¼”ç¤ºï¼Œä¸å­˜å‚¨ä»»ä½•è§†é¢‘èµ„æºã€‚<br>
            æ‰€æœ‰å†…å®¹å‡æ¥è‡ªç¬¬ä¸‰æ–¹å¹³å°ï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚
        </div>
    </footer>

    <!-- è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // ==================== 1. é…ç½®éƒ¨åˆ† ====================
        const CONFIG = {
            // ç”µå½±æ•°æ®åº“APIï¼ˆè·å–å°é¢å’Œç”µå½±ä¿¡æ¯ï¼‰
            TMDB_API_KEY: '9b36b4e6e4f94f4a6b4e6e4f94f4a6b4', // å…è´¹APIå¯†é’¥
            TMDB_BASE_URL: 'https://api.themoviedb.org/3',
            TMDB_IMAGE_URL: 'https://image.tmdb.org/t/p/w500',
            
            // é»˜è®¤æ¨èç”µå½±ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
            DEFAULT_MOVIES: {
                hot: [
                    { title: "æµæµªåœ°çƒ2", year: "2023", tmdbId: "843794" },
                    { title: "æ»¡æ±Ÿçº¢", year: "2023", tmdbId: "813477" },
                    { title: "æ·±æµ·", year: "2023", tmdbId: "813478" },
                    { title: "æ— å", year: "2023", tmdbId: "813479" }
                ],
                new: [
                    { title: "å¥¥æœ¬æµ·é»˜", year: "2023", tmdbId: "872585" },
                    { title: "èŠ­æ¯”", year: "2023", tmdbId: "346698" },
                    { title: "é“¶æ²³æŠ¤å«é˜Ÿ3", year: "2023", tmdbId: "447365" },
                    { title: "é€Ÿåº¦ä¸æ¿€æƒ…10", year: "2023", tmdbId: "385687" }
                ]
            }
        };

        // ==================== 2. å…¨å±€çŠ¶æ€ ====================
        let currentSearchResults = [];
        let currentVideoSources = [];

        // ==================== 3. ç²’å­èƒŒæ™¯åˆå§‹åŒ– ====================
        particlesJS('particles-js', {
            particles: {
                number: { value: 80 },
                color: { value: "#00d4ff" },
                shape: { type: "circle" },
                opacity: { value: 0.5 },
                size: { value: 3 },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#00d4ff",
                    opacity: 0.2,
                    width: 1
                },
                move: { enable: true, speed: 2 }
            },
            interactivity: {
                events: {
                    onhover: { enable: true, mode: "repulse" },
                    onclick: { enable: true, mode: "push" }
                }
            },
            retina_detect: true
        });

        // ==================== 4. æ ¸å¿ƒåŠŸèƒ½ï¼šæ™ºèƒ½æœç´¢ ====================
        async function smartSearch(query) {
            showLoading(true);
            
            try {
                // 1. å…ˆå°è¯•ä»TMDBè·å–ç”µå½±ä¿¡æ¯
                const tmdbResults = await searchTMDB(query);
                
                if (tmdbResults.length > 0) {
                    // 2. ä¸ºæ¯ä¸ªç»“æœæœç´¢æ’­æ”¾æº
                    const enhancedResults = await Promise.all(
                        tmdbResults.map(async (movie) => {
                            const sources = await searchVideoSources(movie.title, movie.year);
                            return {
                                ...movie,
                                sources,
                                poster: movie.poster || `https://picsum.photos/seed/${encodeURIComponent(movie.title)}/300/450`
                            };
                        })
                    );
                    
                    displaySearchResults(enhancedResults);
                } else {
                    // 3. å¦‚æœTMDBæ²¡æœ‰ç»“æœï¼Œä½¿ç”¨é»˜è®¤æœç´¢
                    const defaultResults = await searchDefaultSources(query);
                    displaySearchResults(defaultResults);
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                // 4. é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                displayFallbackResults(query);
            } finally {
                showLoading(false);
            }
        }

        // ==================== 5. TMDBæœç´¢å‡½æ•° ====================
        async function searchTMDB(query) {
            try {
                const response = await fetch(
                    `${CONFIG.TMDB_BASE_URL}/search/multi?api_key=${CONFIG.TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=zh-CN&page=1`
                );
                
                if (!response.ok) throw new Error('TMDB APIè¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                
                return data.results.slice(0, 10).map(item => ({
                    id: item.id,
                    title: item.title || item.name,
                    year: item.release_date ? item.release_date.split('-')[0] : 'æœªçŸ¥',
                    type: item.media_type,
                    rating: item.vote_average ? item.vote_average.toFixed(1) : 'æ— ',
                    overview: item.overview || 'æš‚æ— ç®€ä»‹',
                    poster: item.poster_path ? CONFIG.TMDB_IMAGE_URL + item.poster_path : null
                }));
            } catch (error) {
                console.warn('TMDBæœç´¢å¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ:', error);
                return [];
            }
        }

        // ==================== 6. è§†é¢‘æºæœç´¢å‡½æ•° ====================
        async function searchVideoSources(title, year) {
            // è¿™é‡Œå¯ä»¥æ¥å…¥å®é™…çš„è§†é¢‘æºAPI
            // ç›®å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const mockSources = [
                { name: 'Bç«™', type: 'bilibili', url: generateBilibiliSearch(title) },
                { name: 'çˆ±å¥‡è‰º', type: 'iqiyi', url: `https://www.iqiyi.com/search.html?source=input&key=${encodeURIComponent(title)}` },
                { name: 'è…¾è®¯è§†é¢‘', type: 'tencent', url: `https://v.qq.com/x/search/?q=${encodeURIComponent(title)}` },
                { name: 'ä¼˜é…·', type: 'youku', url: `https://so.youku.com/search_video/q_${encodeURIComponent(title)}` }
            ];
            
            return mockSources;
        }

        // ==================== 7. ç”ŸæˆBç«™æœç´¢é“¾æ¥ ====================
        function generateBilibiliSearch(title) {
            // ä½¿ç”¨Bç«™æœç´¢é¡µé¢
            return `https://search.bilibili.com/all?keyword=${encodeURIComponent(title)}&from_source=webtop_search`;
        }

        // ==================== 8. é»˜è®¤æœç´¢å‡½æ•° ====================
        async function searchDefaultSources(query) {
            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ¨¡æ‹Ÿæœç´¢ç»“æœ
            return [
                {
                    id: 1,
                    title: query + " (ç”µå½±)",
                    year: "2023",
                    type: "movie",
                    rating: "8.5",
                    overview: `å…³äº"${query}"çš„ç”µå½±ä½œå“`,
                    poster: `https://picsum.photos/seed/${encodeURIComponent(query + '1')}/300/450`,
                    sources: [
                        { name: 'Bç«™', type: 'bilibili', url: generateBilibiliSearch(query) }
                    ]
                },
                {
                    id: 2,
                    title: query + " (å‰§é›†)",
                    year: "2023",
                    type: "tv",
                    rating: "8.2",
                    overview: `å…³äº"${query}"çš„ç”µè§†å‰§ä½œå“`,
                    poster: `https://picsum.photos/seed/${encodeURIComponent(query + '2')}/300/450`,
                    sources: [
                        { name: 'è…¾è®¯è§†é¢‘', type: 'tencent', url: `https://v.qq.com/x/search/?q=${encodeURIComponent(query)}` }
                    ]
                }
            ];
        }

        // ==================== 9. æ˜¾ç¤ºæœç´¢ç»“æœ ====================
        function displaySearchResults(results) {
            currentSearchResults = results;
            
            const resultsGrid = document.getElementById('resultsGrid');
            const resultCount = document.getElementById('resultCount');
            const searchResults = document.getElementById('searchResults');
            const recommendations = document.getElementById('recommendations');
            
            // æ›´æ–°è®¡æ•°
            resultCount.textContent = `æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`;
            
            // ç”Ÿæˆç»“æœå¡ç‰‡
            resultsGrid.innerHTML = results.map(movie => `
                <div class="result-item" data-id="${movie.id}" data-title="${movie.title}">
                    <img src="${movie.poster}" alt="${movie.title}" 
                         onerror="this.src='https://picsum.photos/300/450'">
                    <div class="result-info">
                        <div class="result-title">${movie.title}</div>
                        <div class="result-year">${movie.year} Â· ${movie.type === 'movie' ? 'ç”µå½±' : 'å‰§é›†'} Â· â­ ${movie.rating}</div>
                        <div style="margin-top: 0.5rem;">
                            ${movie.sources.slice(0, 2).map(source => 
                                `<span style="background: rgba(0,212,255,0.1); color: var(--primary); 
                                    padding: 2px 8px; border-radius: 10px; margin-right: 5px; 
                                    font-size: 0.8rem;">${source.name}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // æ˜¾ç¤ºæœç´¢ç»“æœï¼Œéšè—æ¨è
            searchResults.style.display = 'block';
            recommendations.style.display = 'none';
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const movieId = this.getAttribute('data-id');
                    const movieTitle = this.getAttribute('data-title');
                    const movie = results.find(m => m.id == movieId);
                    if (movie) {
                        showVideoPlayer(movie);
                    }
                });
            });
        }

        // ==================== 10. å¤‡ç”¨ç»“æœæ˜¾ç¤º ====================
        function displayFallbackResults(query) {
            const fallbackResults = [
                {
                    id: 'fallback1',
                    title: `æœç´¢"${query}"çš„å½±ç‰‡`,
                    year: "2023",
                    type: "movie",
                    rating: "8.0",
                    overview: "è¯·å°è¯•ä½¿ç”¨æ›´å…·ä½“çš„å…³é”®è¯æœç´¢",
                    poster: "https://picsum.photos/seed/movie/300/450",
                    sources: [
                        { name: 'Bç«™æœç´¢', type: 'bilibili', url: generateBilibiliSearch(query) }
                    ]
                }
            ];
            
            displaySearchResults(fallbackResults);
        }

        // ==================== 11. æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨ ====================
        function showVideoPlayer(movie) {
            const modal = document.getElementById('videoModal');
            const titleEl = document.getElementById('modalTitle');
            const container = document.getElementById('videoContainer');
            
            titleEl.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${movie.title}`;
            
            // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªæº
            const primarySource = movie.sources[0];
            let embedCode = '';
            
            if (primarySource.type === 'bilibili') {
                // å°è¯•è·å–Bç«™è§†é¢‘IDï¼ˆè¿™é‡Œéœ€è¦çœŸå®é€»è¾‘ï¼‰
                const bvid = guessBilibiliVideoId(movie.title);
                embedCode = generateBilibiliEmbed(bvid);
            } else {
                // å…¶ä»–è§†é¢‘æºä½¿ç”¨iframeåµŒå…¥
                embedCode = `
                    <iframe src="${primarySource.url}" 
                            width="100%" 
                            height="600" 
                            frameborder="0" 
                            allowfullscreen
                            style="border-radius: 10px;">
                    </iframe>
                `;
            }
            
            container.innerHTML = embedCode;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // ä¿å­˜å½“å‰è§†é¢‘ä¿¡æ¯
            currentVideoSources = movie.sources;
            
            // ç»‘å®šæ’­æ”¾æºåˆ‡æ¢
            document.querySelectorAll('[data-player]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playerType = this.getAttribute('data-player');
                    switchVideoPlayer(movie, playerType);
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('[data-player]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // ==================== 12. ç”ŸæˆBç«™åµŒå…¥ä»£ç  ====================
        function generateBilibiliEmbed(bvid) {
            // ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„ç¤ºä¾‹è§†é¢‘IDï¼Œå®é™…ä¸­åº”è¯¥æ ¹æ®æœç´¢è·å–çœŸå®ID
            const defaultBvid = 'BV1MJ41157D3';
            const videoId = bvid || defaultBvid;
            
            return `
                <iframe 
                    src="https://player.bilibili.com/player.html?bvid=${videoId}&autoplay=1&page=1"
                    width="100%" 
                    height="600" 
                    scrolling="no" 
                    border="0" 
                    frameborder="no" 
                    framespacing="0" 
                    allowfullscreen="true"
                    style="border-radius: 10px;">
                </iframe>
            `;
        }

        // ==================== 13. çŒœæµ‹Bç«™è§†é¢‘ID ====================
        function guessBilibiliVideoId(title) {
            // è¿™é‡Œåº”è¯¥æœ‰ä¸€ä¸ªæ˜ å°„è¡¨æˆ–APIè°ƒç”¨
            // ç›®å‰è¿”å›ä¸€ä¸ªç¤ºä¾‹ID
            const videoMap = {
                'æµæµªåœ°çƒ': 'BV1fX4y1V7Vc',
                'æ»¡æ±Ÿçº¢': 'BV1cT411R7tY',
                'ä¸‰ä½“': 'BV1Gu4y1U7YJ',
                'ç‹‚é£™': 'BV1No4y1Z7K8'
            };
            
            for (const [key, value] of Object.entries(videoMap)) {
                if (title.includes(key)) {
                    return value;
                }
            }
            
            return 'BV1MJ41157D3'; // é»˜è®¤è§†é¢‘ID
        }

        // ==================== 14. åˆ‡æ¢æ’­æ”¾å™¨ç±»å‹ ====================
        function switchVideoPlayer(movie, playerType) {
            const container = document.getElementById('videoContainer');
            
            switch(playerType) {
                case 'bilibili':
                    const bvid = guessBilibiliVideoId(movie.title);
                    container.innerHTML = generateBilibiliEmbed(bvid);
                    break;
                    
                case 'iframe':
                    // ä½¿ç”¨ç½‘é¡µåµŒå…¥
                    const source = movie.sources.find(s => s.type !== 'bilibili') || movie.sources[0];
                    container.innerHTML = `
                        <iframe src="${source.url}" 
                                width="100%" 
                                height="600" 
                                frameborder="0" 
                                allowfullscreen
                                style="border-radius: 10px;">
                        </iframe>
                    `;
                    break;
                    
                case 'direct':
                    // ç›´æ¥è·³è½¬
                    const bilibiliSource = movie.sources.find(s => s.type === 'bilibili');
                    if (bilibiliSource) {
                        window.open(bilibiliSource.url, '_blank');
                    } else {
                        window.open(movie.sources[0].url, '_blank');
                    }
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <i class="fas fa-external-link-alt" style="font-size: 4rem; color: var(--primary);"></i>
                            <h3 style="margin-top: 1rem; color: var(--primary);">å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</h3>
                            <p style="color: rgba(255,255,255,0.7);">å¦‚æœæ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»é“¾æ¥</p>
                        </div>
                    `;
                    break;
            }
        }

        // ==================== 15. åŠ è½½çŠ¶æ€æ§åˆ¶ ====================
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const searchBtn = document.getElementById('searchBtn');
            
            if (show) {
                loading.style.display = 'block';
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æœç´¢ä¸­...';
                searchBtn.disabled = true;
            } else {
                loading.style.display = 'none';
                searchBtn.innerHTML = '<i class="fas fa-search"></i> æ™ºèƒ½æœç´¢';
                searchBtn.disabled = false;
            }
        }

        // ==================== 16. åˆå§‹åŒ–æ¨èå†…å®¹ ====================
        async function initRecommendations() {
            const hotGrid = document.getElementById('hotMovies');
            const newGrid = document.getElementById('newMovies');
            
            // åŠ è½½çƒ­é—¨æ¨è
            const hotMovies = await Promise.all(
                CONFIG.DEFAULT_MOVIES.hot.map(async movie => {
                    const sources = await searchVideoSources(movie.title, movie.year);
                    return {
                        ...movie,
                        poster: `${CONFIG.TMDB_IMAGE_URL}/p/original`,
                        sources,
                        poster: `https://picsum.photos/seed/${encodeURIComponent(movie.title + 'hot')}/300/450`
                    };
                })
            );
            
            // åŠ è½½æœ€æ–°ä¸Šçº¿
            const newMovies = await Promise.all(
                CONFIG.DEFAULT_MOVIES.new.map(async movie => {
                    const sources = await searchVideoSources(movie.title, movie.year);
                    return {
                        ...movie,
                        sources,
                        poster: `https://picsum.photos/seed/${encodeURIComponent(movie.title + 'new')}/300/450`
                    };
                })
            );
            
            // æ¸²æŸ“çƒ­é—¨æ¨è
            hotGrid.innerHTML = hotMovies.map(movie => `
                <div class="movie-card" data-title="${movie.title}">
                    <img src="${movie.poster}" alt="${movie.title}" class="card-img">
                    <div class="card-overlay">
                        <h3 class="card-title">${movie.title}</h3>
                        <div class="card-meta">
                            <span>${movie.year}</span>
                            <span>â­ 8.0+</span>
                        </div>
                        <div class="card-actions">
                            <button class="watch-btn" onclick="playRecommendedMovie('${movie.title}')">
                                <i class="fas fa-play"></i> ç«‹å³è§‚çœ‹
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // æ¸²æŸ“æœ€æ–°ä¸Šçº¿
            newGrid.innerHTML = newMovies.map(movie => `
                <div class="movie-card" data-title="${movie.title}">
                    <img src="${movie.poster}" alt="${movie.title}" class="card-img">
                    <div class="card-overlay">
                        <h3 class="card-title">${movie.title}</h3>
                        <div class="card-meta">
                            <span>${movie.year}</span>
                            <span>â­ 8.0+</span>
                        </div>
                        <div class="card-actions">
                            <button class="watch-btn" onclick="playRecommendedMovie('${movie.title}')">
                                <i class="fas fa-play"></i> ç«‹å³è§‚çœ‹
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== 17. æ’­æ”¾æ¨èç”µå½± ====================
        async function playRecommendedMovie(title) {
            showLoading(true);
            
            try {
                const results = await searchTMDB(title);
                if (results.length > 0) {
                    const movie = results[0];
                    const sources = await searchVideoSources(movie.title, movie.year);
                    movie.sources = sources;
                    
                    showVideoPlayer(movie);
                } else {
                    // å¦‚æœTMDBæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤æ’­æ”¾
                    const movie = {
                        title: title,
                        year: "2023",
                        type: "movie",
                        rating: "8.5",
                        poster: `https://picsum.photos/seed/${encodeURIComponent(title)}/300/450`,
                        sources: [
                            { name: 'Bç«™', type: 'bilibili', url: generateBilibiliSearch(title) }
                        ]
                    };
                    
                    showVideoPlayer(movie);
                }
            } catch (error) {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æœç´¢è¯¥å½±ç‰‡');
            } finally {
                showLoading(false);
            }
        }

        // ==================== 18. äº‹ä»¶ç»‘å®š ====================
        function bindEvents() {
            // æœç´¢æŒ‰é’®
            document.getElementById('searchBtn').addEventListener('click', () => {
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    smartSearch(query);
                } else {
                    alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                }
            });
            
            // æœç´¢æ¡†å›è½¦
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = document.getElementById('searchInput').value.trim();
                    if (query) {
                        smartSearch(query);
                    }
                }
            });
            
            // å¿«é€Ÿæœç´¢é“¾æ¥
            document.querySelectorAll('.quick-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const query = this.getAttribute('data-search');
                    document.getElementById('searchInput').value = query;
                    smartSearch(query);
                });
            });
            
            // å¯¼èˆªæŒ‰é’®
            document.getElementById('homeBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('recommendations').style.display = 'block';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchInput').value = '';
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('closeModal').addEventListener('click', () => {
                const modal = document.getElementById('videoModal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // åœæ­¢è§†é¢‘æ’­æ”¾
                const iframe = document.querySelector('#videoContainer iframe');
                if (iframe) {
                    iframe.src = iframe.src; // é‡æ–°åŠ è½½ä»¥åœæ­¢æ’­æ”¾
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.getElementById('videoModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    
                    const iframe = document.querySelector('#videoContainer iframe');
                    if (iframe) {
                        iframe.src = iframe.src;
                    }
                }
            });
            
            // ç”¨æˆ·æŒ‰é’®
            document.getElementById('userBtn').addEventListener('click', () => {
                alert(`ğŸ‘¤ æ¬¢è¿å›æ¥ï¼Œå¤§æµ·ï¼\n\nğŸ“Š ä»Šæ—¥æ¨èï¼š\nâ€¢ æµæµªåœ°çƒ2 - ç§‘å¹»å·¨åˆ¶\nâ€¢ æ»¡æ±Ÿçº¢ - å¤è£…æ‚¬ç–‘\nâ€¢ ä¸‰ä½“ - ç§‘å¹»ç¥ä½œ\n\nğŸ¯ åŠŸèƒ½æç¤ºï¼š\nè¾“å…¥ç”µå½±åç§°å³å¯æ™ºèƒ½æœç´¢æ’­æ”¾`);
            });
        }

        // ==================== 19. é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initRecommendations();
            bindEvents();
            
            // æ·»åŠ æœç´¢å»ºè®®
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('focus', function() {
                if (!this.value) {
                    this.placeholder = 'è¯•è¯•è¾“å…¥ï¼šæµæµªåœ°çƒã€ä¸‰ä½“ã€ç‹‚é£™ã€é¬¼ç­ä¹‹åˆƒ...';
                }
            });
            
            searchInput.addEventListener('blur', function() {
                this.placeholder = 'è¾“å…¥ç”µå½±ã€ç”µè§†å‰§ã€åŠ¨æ¼«åç§°ï¼Œå¦‚ï¼šæµæµªåœ°çƒã€æƒåŠ›çš„æ¸¸æˆ...';
            });
            
            console.log('ğŸ¬ æ™ºèƒ½å½±è§†ç½‘ç«™å·²åŠ è½½å®Œæˆï¼');
            console.log('ğŸ” åŠŸèƒ½ï¼šæ™ºèƒ½æœç´¢ + å°é¢åŒ¹é… + å¤šæºæ’­æ”¾');
        });

        // ==================== 20. å…¨å±€å¯¼å‡ºå‡½æ•° ====================
        window.playRecommendedMovie = playRecommendedMovie;
    </script>
</body>
</html>
